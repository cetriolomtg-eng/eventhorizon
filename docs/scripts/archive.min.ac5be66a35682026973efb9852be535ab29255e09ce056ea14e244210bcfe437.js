(()=>{"use strict";if(!document.querySelector("section.archive"))return;const c="(max-width: 1023.98px)",l="(max-width: 768px)",s="true",n="false",e=(e,t=document)=>t.querySelector(e),a=(e,t=document)=>Array.from(t.querySelectorAll(e)),t=(e,t,n,s)=>e&&e.addEventListener(t,n,s),d=(e,t,n)=>e&&e.setAttribute(t,String(n)),o=window.matchMedia?window.matchMedia(c):{matches:!0,addEventListener(){}},i=window.matchMedia?window.matchMedia(l):{matches:!1,addEventListener(){}},u=()=>new URL(window.location.href),r=e=>u().searchParams.get(e);(()=>{const n=e(".archive-sheet"),l=e(".archive-sheet-backdrop");if(!n||!l)return;const m=e(".archive-sheet__close",n),s=e(".archive-sheet__handle",n),j=e("#archive-sheet-title",n),b=e(".archive-sheet__content",n),h=e(".archive-sheet__ctas",n);let c=null;const u=e=>{if(e.key!=="Tab")return;const t=a('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])',n).filter(e=>!e.hasAttribute("disabled")&&e.getAttribute("aria-hidden")!=="true");if(!t.length)return;const s=t[0],o=t[t.length-1];e.shiftKey&&document.activeElement===s?(o.focus(),e.preventDefault()):!e.shiftKey&&document.activeElement===o&&(s.focus(),e.preventDefault())},v=e=>{if(!o.matches)return;c=document.activeElement,j.textContent=e.title||"",b.innerHTML=e.descHtml||"",h.innerHTML="",(e.links||[]).forEach(e=>{const t=document.createElement("a");t.className=e.cls||"pill btn--base",t.href=e.url,t.target="_blank",t.rel="noopener",t.title=e.lab||"Apri",t.textContent=e.lab||"Apri",h.appendChild(t)}),n.setAttribute("aria-hidden","false"),l.setAttribute("aria-hidden","false"),document.body.classList.add("no-scroll"),n.addEventListener("keydown",u),(m||n).focus()},d=()=>{n.setAttribute("aria-hidden","true"),l.setAttribute("aria-hidden","true"),document.body.classList.remove("no-scroll"),n.removeEventListener("keydown",u),c&&typeof c.focus=="function"&&c.focus()};t(m,"click",d),t(l,"click",d);let i=null,r=null;const f=e=>{i=e.touches?e.touches[0].clientY:e.clientY,r=i},p=e=>{if(i==null)return;r=e.touches?e.touches[0].clientY:e.clientY},g=()=>{i!=null&&r!=null&&r-i>60&&d(),i=r=null};t(s,"mousedown",f),t(s,"mousemove",p),t(s,"mouseup",g),t(s,"touchstart",f,{passive:!0}),t(s,"touchmove",p,{passive:!0}),t(s,"touchend",g),document.addEventListener("click",e=>{const s=e.target&&e.target.closest(".item-actions-summary");if(!s||!o.matches)return;const n=s.closest(".item"),i=n&&n.closest(".archive-item");if(!i)return;const t=i.querySelector(".item-panel"),r=t?t.querySelector(".item-summary"):null,c=t?a(".item-ctas a",t):[],l=n.querySelector(".item-title")?.textContent||"",d=c.map(e=>({url:e.getAttribute("href"),lab:e.textContent.trim(),cls:e.className}));v({title:l,descHtml:r?`<p class="item-summary">${r.textContent}</p>`:"",links:d}),e.preventDefault()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&n.getAttribute("aria-hidden")==="false"&&d()})})(),(()=>{const t=window.matchMedia?window.matchMedia("(max-width: 1023.98px)"):{matches:!0},o=o=>{if(t.matches)return;const i=o.target&&o.target.closest(".item");if(!i)return;const r=i.closest(".archive-item");if(!r)return;const c=e(".item-panel",r),l=e(".item-actions-summary",i);if(!c||!l)return;const a=!i.classList.contains("is-open");i.classList.toggle("is-open",a),d(l,"aria-expanded",a?s:n);try{c.hidden=!a}catch{}};document.addEventListener("click",e=>{const n=e.target&&e.target.closest(".item-actions-summary");if(!n)return;t.matches||o(e)})})(),(()=>{const t=e("#archive-search-form");if(!t)return;const n=e("#q",t),s=()=>{if(!n)return;n.placeholder=i.matches?"Cerca":"Cerca per titolo, descrizione o tagâ€¦"};s(),i.addEventListener&&i.addEventListener("change",s)})(),(()=>{const l=e("#archive-search-form"),u=e("#q",l||document),c=e("#kind",l||document),i=e(".archive-search__filter-toggle",l||document),h=(r("kind")||"").toLowerCase();c&&(c.value=h==="video"||h==="content"?h:"");const m=!!(c&&c.value!=="");i&&(i.setAttribute("aria-pressed",m?s:n),i.classList.toggle("is-active",m),i.setAttribute("aria-expanded",n)),u&&(u.value=r("q")||"");let a=null;const d=()=>{a&&a.parentNode&&a.parentNode.removeChild(a),a=null,i&&i.setAttribute("aria-expanded",n),document.removeEventListener("click",f,!0),document.removeEventListener("keydown",p,!0)},f=e=>{if(!a)return;const t=e.target&&(a.contains(e.target)||i&&i.contains(e.target));t||d()},p=e=>{e.key==="Escape"&&d()},g=()=>{a&&d(),a=document.createElement("div"),a.className="filter-popover",a.setAttribute("role","menu"),a.setAttribute("aria-label","Filtro contenuti");const e=c?c.value:"";a.innerHTML=`
        <ul class="filter-popover__list" role="none">
          <li role="none">
            <button type="button" class="filter-popover__item" role="menuitemradio" aria-checked="${e===""?"true":"false"}" data-value="">Tutti</button>
          </li>
          <li role="none">
            <button type="button" class="filter-popover__item" role="menuitemradio" aria-checked="${e==="video"?"true":"false"}" data-value="video">Video</button>
          </li>
          <li role="none">
            <button type="button" class="filter-popover__item" role="menuitemradio" aria-checked="${e==="content"?"true":"false"}" data-value="content">Contenuti</button>
          </li>
        </ul>
      `,document.body.appendChild(a);const t=i.getBoundingClientRect(),l=8,o=Math.max(t.width,180),u=Math.max(8,Math.min(window.innerWidth-o-8,t.left));Object.assign(a.style,{position:"fixed",top:`${Math.min(window.innerHeight-8,t.bottom+l)}px`,left:`${u}px`,minWidth:`${o}px`,zIndex:"10000"});const r=a.querySelector('.filter-popover__item[aria-checked="true"]')||a.querySelector(".filter-popover__item");r&&r.focus({preventScroll:!0}),document.addEventListener("click",f,!0),document.addEventListener("keydown",p,!0),a.addEventListener("click",e=>{const o=e.target&&e.target.closest(".filter-popover__item");if(!o)return;const t=(o.getAttribute("data-value")||"").toLowerCase();if(c){c.value=t==="video"||t==="content"?t:"";const e=c.value!=="";i&&(i.setAttribute("aria-pressed",e?s:n),i.classList.toggle("is-active",e))}d(),i&&i.focus()}),i&&i.setAttribute("aria-expanded",s)};document.addEventListener("click",e=>{const t=e.target&&e.target.closest(".archive-search__filter-toggle");if(!t)return;if(o.matches)e.preventDefault(),a?d():g();else{const e=document.getElementById("kind");e&&e.focus()}}),l&&t(l,"submit",()=>{try{const e=new URL(l.action||window.location.href);e.searchParams.delete("p"),l.action=e.toString()}catch{}}),document.addEventListener("click",e=>{const s=e.target&&e.target.closest(".archive-search__reset");if(!s)return;e.preventDefault(),d();const t=new URL(window.location.href);t.searchParams.delete("q"),t.searchParams.delete("p"),t.searchParams.delete("kind"),u&&(u.value=""),c&&(c.value=""),i&&(i.setAttribute("aria-pressed",n),i.classList.remove("is-active"),i.setAttribute("aria-expanded",n)),window.location.href=t.toString()})})()})(),(()=>{"use strict";if(!document.querySelector("section.archive"))return;const l=(e,t=document)=>t.querySelector(e),s=e=>e==null?"":String(e),e=e=>s(e).toLowerCase(),t=e=>s(e).trim(),a=()=>new URL(window.location.href),n=e=>a().searchParams.get(e),o=(t,n)=>e(t).includes(e(n)),r=e=>/^(data:|https?:|\/\/)/i.test(e),k=(e,t)=>r(e)?e:e+(t?`?v=${t}`:""),_=t=>{const n=Array.isArray(t)?t:[],s=n.map(t=>e(t)).join(",");return`,${s},`},j=(t,n)=>{const o=_(t),s=e(n).trim();if(!s)return!1;const i=s.split(/\s+/).filter(Boolean);for(let e=0;e<i.length;e++)if(o.includes(i[e]))return!0;return!!o.includes(s)},d=n=>{const s=e(t(n));if(!s)return"btn--base";const i=s.match(/\bbtn--[a-z0-9-]+\b/);if(i)return i[0];const o={youtube:"btn--yt",yt:"btn--yt",scryfall:"btn--scry",scry:"btn--scry",edhrec:"btn--edh",edh:"btn--edh",moxfield:"btn--mox",mox:"btn--mox",archidekt:"btn--archi",archi:"btn--archi",teal:"btn--teal",gold:"btn--gold",primary:"primary",indigo:"btn--base",base:"btn--base",default:"btn--base"},a=s.split(/\s+/);for(const e of a)if(o[e])return o[e];for(const e in o)if(s.includes(e))return o[e];return"btn--base"},h=e=>{try{const t=new URL(e,window.location.origin).host.toLowerCase();if(t.includes("youtube.com")||t.includes("youtu.be"))return"btn--yt";if(t.includes("scryfall.com"))return"btn--scry";if(t.includes("edhrec.com"))return"btn--edh";if(t.includes("moxfield.com"))return"btn--mox";if(t.includes("archidekt.com"))return"btn--archi"}catch{}return null},m=(e,t)=>{let n=d(e);if(n==="btn--base"){const e=h(t);e&&(n=e)}return`pill ${n}`},f=(e,n)=>{const s=t(e);if(s)return s;try{const e=new URL(n,window.location.origin).host;return e||"Apri"}catch{return"Apri"}},p=()=>{const e=parseInt(n("p")||"1",10);return isNaN(e)||e<1?1:e},g=()=>{const t=document.documentElement.getAttribute("data-archive-page-size"),e=parseInt(t||"12",10);return isNaN(e)?12:Math.max(5,Math.min(24,e))},v=t(n("q")||""),b=(n("kind")||"").toLowerCase().trim(),u=n=>{const v=s(n.id),y=e(s(n.kind)||"content"),b=t(n.overline||""),l=t(n.title||""),d=t(n.desc||"");let i=t(n.thumb||"");i&&!r(i)&&(i="/"+i.replace(/^\/+/,""));const w=document.documentElement.getAttribute("data-app-ver")||"",g=k(i||"/assets/cards/fblthp_placeholder.webp",w),o=Array.isArray(n.links)?n.links.slice().sort((e,t)=>(e.sort_order??0)-(t.sort_order??0)):[];let a=null;for(let t=0;t<o.length;t++){const n=e(o[t]?.btn_class||"");if(n&&/\bprimary\b/.test(n)){a=t;break}}const u=a!=null?t(o[a].href||""):"",h=[];for(let e=0;e<o.length;e++){if(e===a)continue;const s=o[e],n=t(s?.href||"");if(!n)continue;h.push({url:n,lab:f(s?.label||"",n),cls:m(s?.btn_class||"",n)})}const j=`links-${v.replace(/[^a-zA-Z0-9_-]+/g,"-")}`,c=h.length,_=!!d||c>0,O=c>0?`Dettagli e link (${c})`:"Dettagli",x=c?`<div class="item-ctas" role="group" aria-label="Collegamenti">
           ${h.map(e=>`<a class="${e.cls}" href="${e.url}" target="_blank" rel="noopener" title="${e.lab}">${e.lab}</a>`).join("")}
         </div>`:"",p=document.createElement("li");return p.className=`archive-item is-${y}`,p.innerHTML=`
      <article class="item" data-item-id="${v}" data-kind="${y}">
        <header class="item-head">
          ${b?`<p class="item-overline">${b}</p>`:""}
          <h2 class="item-title">${l}</h2>
        </header>
        ${u?`<a class="item-thumb${u&&/\bprimary\b/.test(e(o[a]?.btn_class||""))?" primary":""}"
                href="${u}" target="_blank" rel="noopener" aria-label="Apri: ${l}">
               <img src="${g}" alt="Anteprima: ${l}" loading="lazy" decoding="async">
             </a>`:`<figure class="item-thumb">
               <img src="${g}" alt="Anteprima: ${l}" loading="lazy" decoding="async">
             </figure>`}
        ${_?`<button class="item-actions-summary" type="button" aria-controls="${j}" aria-expanded="false">
                 <span class="sr-only">${O}</span>
               </button>`:""}
      </article>
      ${_?`<div class="item-panel" id="${j}" hidden>
             ${d?`<div class="item-descbar"><p class="item-summary">${d}</p></div>`:""}
             ${x}
           </div>`:""}
    `,p},y=(t,n,s)=>{const i=e(n).trim(),a=e(s);return t.filter(t=>{if(a&&a!==e(t.kind||""))return!1;if(!i)return!0;const n=o(t.title||"",i)||o(t.overline||"",i)||o(t.desc||"",i),s=j(t.tags||[],i);return n||s})},i=e=>{const t=Date.parse(e);return isNaN(t)?0:t},w=e=>e.slice().sort((e,t)=>{const n=i(e.date),o=i(t.date);if(n!==o)return o-n;const a=s(e.id),r=s(t.id);return a<r?1:a>r?-1:0}),O=(e,t,n)=>{const s=e.length,o=Math.max(1,Math.ceil(s/n)),i=Math.min(Math.max(1,t),o),a=(i-1)*n,r=a+n;return{total:s,pages:o,page:i,slice:e.slice(a,r)}},x=e=>{const i=l(".archive-pager");if(!i)return;const m=a(),{page:t,pages:r}=e,s=i.querySelector('a[rel="prev"]'),o=i.querySelector('a[rel="next"]'),u=i.querySelector(".curr"),h=(e,t)=>{if(!e)return;const s=new URL(m);s.searchParams.set("p",t);const o=n("q"),i=n("kind");o?s.searchParams.set("q",o):s.searchParams.delete("q"),i?s.searchParams.set("kind",i):s.searchParams.delete("kind"),e.href=s.toString()},c=t<=1;s&&(s.classList.toggle("disabled",c),s.setAttribute("aria-disabled",c?"true":"false"),h(s,c?1:t-1),s.rel="prev"),u&&(u.textContent=`Pag. ${t} / ${r}`);const d=t>=r;o&&(o.classList.toggle("disabled",d),o.setAttribute("aria-disabled",d?"true":"false"),h(o,d?r:t+1),o.rel="next")},C=e=>{const t=l(".archive-hero .filter-note strong");t&&(t.textContent=new Intl.NumberFormat("it-IT").format(e))},E=e=>{const i=document.querySelector("section.archive");if(!i)return;const o=i.querySelector(".container")||i;let s=o.querySelector("ol.archive-timeline");if(s||(s=document.createElement("ol"),s.className="archive-timeline",o.appendChild(s)),s.innerHTML="",!e.length){const e=document.createElement("p");e.className="empty",e.setAttribute("role","status"),e.setAttribute("aria-live","polite");const o=t(n("q")||"");e.innerHTML=`Nessun risultato per <em>${o}</em>.`,s.replaceWith(e);return}const r=o.querySelector("p.empty");r&&(r.remove(),s=document.createElement("ol"),s.className="archive-timeline",o.appendChild(s));const a=document.createDocumentFragment();for(const t of e)a.appendChild(u(t));s.appendChild(a)},c=async()=>{try{const n=document.documentElement.getAttribute("data-app-ver")||"",s=n?`?v=${n}`:"",e=await fetch(`/archive/list.json${s}`,{credentials:"same-origin"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const o=await e.json(),i=g(),a=p(),r=y(o,v,b),c=w(r),t=O(c,a,i);C(t.total),E(t.slice),x(t)}catch(e){console.error("[archive] dataset error:",e)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c()})()