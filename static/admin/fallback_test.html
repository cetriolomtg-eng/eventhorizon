<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <title>Fallback Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
      pre { background: #f5f5f5; padding: 12px; }
    </style>
    <script>
      // Intercetta postMessage per tracciare la chiamata dal fallback
      (function(){
        var _pm = window.postMessage;
        window.__lastPostMessage = null;
        window.postMessage = function(msg, target) {
          window.__lastPostMessage = { msg: String(msg), target: String(target) };
          return _pm.apply(this, arguments);
        };
      })();
    </script>
    <script>
      // Copia del fallback di static/admin/index.html
      (function () {
        function parseAuthFromHashOrQuery() {
          var h = window.location.hash || "";
          var q = window.location.search || "";

          if (h && h !== "#" && h !== "#/") {
            var hash = h.charAt(0) === "#" ? h.slice(1) : h;
            var legacyPrefix = "authorization:github:success:";
            if (hash.indexOf(legacyPrefix) === 0) {
              try {
                var raw = decodeURIComponent(hash.slice(legacyPrefix.length));
                var data = JSON.parse(raw);
                if (!data.provider) data.provider = "github";
                return data;
              } catch (e) {}
            }
            try {
              var paramsH = new URLSearchParams(hash);
              var tokenH = paramsH.get("access_token") || paramsH.get("token");
              var providerH = paramsH.get("provider") || paramsH.get("authorization") || "github";
              if (tokenH) return { token: tokenH, provider: providerH };
            } catch (_) {}
          }

          if (q && q.length > 1) {
            try {
              var paramsQ = new URLSearchParams(q.charAt(0) === "?" ? q.slice(1) : q);
              var tokenQ = paramsQ.get("access_token") || paramsQ.get("token");
              var providerQ = paramsQ.get("provider") || paramsQ.get("authorization") || "github";
              if (tokenQ) return { token: tokenQ, provider: providerQ };
            } catch (_) {}
          }
          return null;
        }

        function relay() {
          var data = parseAuthFromHashOrQuery();
          if (!data) return;
          try {
            var msg = "authorization:github:success:" + JSON.stringify(data);
            setTimeout(function () {
              window.postMessage(msg, "*");
              var newUrl = window.location.pathname + window.location.search.replace(/^\?$/, "") + "#/";
              history.replaceState(null, "", newUrl);
            }, 0);
          } catch (e) {}
        }

        if (document.readyState === "complete") {
          relay();
        } else {
          window.addEventListener("load", relay);
        }

        window.addEventListener("message", function (ev) {
          if (typeof ev.data === "string" && ev.data.indexOf("authorization:github:success:") === 0) {
            try {
              var target = window.location.pathname + window.location.search.replace(/^\?$/, "") + "#/";
              if (window.location.hash !== "#/") {
                history.replaceState(null, "", target);
              }
            } catch (_) {}
          }
        });
      })();
    </script>
  </head>
  <body>
    <h1>Fallback Test</h1>
    <p>Questo test verifica che il fallback reindirizzi a <code>#/</code> e invii il <code>postMessage</code>.</p>
    <script>
      // Dopo che gli script hanno girato, stampa lo stato
      window.addEventListener('load', function(){
        setTimeout(function(){
          var out = {
            href: window.location.href,
            hash: window.location.hash,
            lastPostMessage: window.__lastPostMessage
          };
          var pre = document.createElement('pre');
          pre.textContent = JSON.stringify(out, null, 2);
          document.body.appendChild(pre);
        }, 50);
      });
    </script>
  </body>
  </html>
