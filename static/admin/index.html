<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EventHorizon Admin</title>

    <!-- Favicon per silenziare 404 (opzionale) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>🔒</text></svg>">

    <!-- Listener PRECOCE: prima di caricare Decap, così non perdiamo il postMessage -->
    <script>
      (function () {
        // Accoda i payload ricevuti finché Decap non è pronto
        window.__oauthQueue = [];

        function isAuthMsg(s) {
          return typeof s === "string" && (
            s.startsWith("authorization:github:success:") ||
            s.startsWith("authorization:github:error:")
          );
        }

        function enqueue(msg) {
          try { window.__oauthQueue.push(String(msg)); } catch(_) {}
        }

        // 1) Ascolta postMessage dal popup (o da altre finestre)
        window.addEventListener("message", function (e) {
          if (!e || typeof e.data !== "string") return;
          if (!isAuthMsg(e.data)) return;
          enqueue(e.data);
        }, false);

        // 2) Leggi fallback via HASH o QUERY (se presente)
        function takeFromUrl() {
          var raw = location.hash ? decodeURIComponent(location.hash.slice(1)) : "";
          if (!raw && location.search) {
            var q = new URLSearchParams(location.search);
            raw = q.get("authorization") || "";
          }
          if (isAuthMsg(raw)) enqueue(raw);
        }
        takeFromUrl();

        // 3) Piccolo dispatcher che riprova finché Decap non “aggancia”
        function flushQueue() {
          if (!window.__oauthQueue || !window.__oauthQueue.length) return;
          // Re-invia i messaggi nell'ambiente della pagina
          try {
            var copy = window.__oauthQueue.slice();
            window.__oauthQueue.length = 0;
            copy.forEach(function (m) {
              // Re-post localmente (origin corretto)
              window.postMessage(m, window.location.origin);
            });
          } catch(_) {}
        }

        // Ripeti flush alcune volte per coprire race (router mount, ecc.)
        var tries = 0, maxTries = 20;
        var iv = setInterval(function () {
          flushQueue();
          tries++;
          if (tries >= maxTries) clearInterval(iv);
        }, 150);

        // Pulisci URL dopo un po' (ma non subito, per consentire a Decap di leggerlo)
        setTimeout(function () {
          if (location.hash && isAuthMsg(decodeURIComponent(location.hash.slice(1)))) {
            history.replaceState(null, "", location.pathname);
          }
        }, 2000);
      })();
    </script>

    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.8.3/dist/decap-cms.js" defer></script>

    <!-- Opzionale: log di debug non verboso -->
    <script defer>
      (function () {
        // Piccolo monitor per capire se i messaggi arrivano davvero
        window.addEventListener("message", function (e) {
          var d = e && e.data;
          if (typeof d === "string" && d.startsWith("authorization:github:")) {
            // console.log("[bridge] received:", d.slice(0, 60) + "…");
          }
        });
      })();
    </script>
  </head>
  <body>
    <script>
      // Avvia Decap (config.yml sarà caricato da /admin/config.yml o dal default in repo)
      // Se usi un percorso non standard, assicurati che il file esista sotto /admin/config.yml
      if (window.CMS && typeof window.CMS.init === "function") {
        window.CMS.init();
      } else {
        // In alcuni casi Decap monta in ritardo
        document.addEventListener("DOMContentLoaded", function () {
          if (window.CMS && typeof window.CMS.init === "function") {
            window.CMS.init();
          }
        });
      }
    </script>
  </body>
</html>

