<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EventHorizon.mtg â€” CMS</title>

    <!-- Favicon silenzia il 404 in console (opzionale) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>ðŸŒ€</text></svg>">

    <!-- Decap CMS (CDN) -->
    <script defer src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!--
      Auth bridge:
      - Intercetta token in hash/query (legacy "authorization:github:success:" o access_token/token)
      - Forza la route su "#/login" prima di dispatchare, cosÃ¬ Decap monta i listener di auth
      - Re-dispatch del messaggio legacy SOLO con {token} e con piccoli retry
      - Pulisce l'URL mantenendo "#/login"
    -->
    <script defer>
      (function () {
        var LOGIN_ROUTE = "#/login";

        function ensureLoginRouteThen(fn) {
          var target = window.location.pathname + window.location.search.replace(/^\?$/, "") + LOGIN_ROUTE;
          if (window.location.hash !== LOGIN_ROUTE) {
            history.replaceState(null, "", target);
            setTimeout(fn, 50); // lascia il tempo al router Decap di montarsi
          } else {
            fn();
          }
        }

        // Invia SOLO {token} in formato legacy, con piccoli retry per evitare race
        function dispatchLegacyTokenOnly(data) {
          var safe = { token: data && data.token ? data.token : null };
          if (!safe.token) return;
          var msg = "authorization:github:success:" + JSON.stringify(safe);

          var tries = 0, max = 3;
          (function tick() {
            window.postMessage(msg, "*");
            if (++tries < max) setTimeout(tick, 150);
          })();
        }

        function parseAuthFromHashOrQuery() {
          var h = window.location.hash || "";
          var q = window.location.search || "";

          // 1) Legacy prefix nel hash (popup fallback del Worker)
          if (h && h !== "#" && h !== "#/" && h !== LOGIN_ROUTE) {
            var hash = h.charAt(0) === "#" ? h.slice(1) : h;

            var legacyPrefix = "authorization:github:success:";
            if (hash.indexOf(legacyPrefix) === 0) {
              try {
                // Alcuni worker non encodano, altri sÃ¬; decodeURIComponent Ã¨ tollerante
                var raw = decodeURIComponent(hash.slice(legacyPrefix.length));
                var data = JSON.parse(raw);
                return { token: data && data.token ? data.token : null };
              } catch (e) {}
            }

            // 1b) Variante: access_token/token nel hash
            try {
              var paramsH = new URLSearchParams(hash);
              var tokenH = paramsH.get("access_token") || paramsH.get("token");
              if (tokenH) return { token: tokenH };
            } catch (_) {}
          }

          // 2) Variante: access_token/token nella query string
          if (q && q.length > 1) {
            try {
              var paramsQ = new URLSearchParams(q.charAt(0) === "?" ? q.slice(1) : q);
              var tokenQ = paramsQ.get("access_token") || paramsQ.get("token");
              if (tokenQ) return { token: tokenQ };
            } catch (_) {}
          }
          return null;
        }

        function relayFromUrlIfPresent() {
          var data = parseAuthFromHashOrQuery();
          if (!data) return;
          ensureLoginRouteThen(function () {
            // 1) invia il messaggio legacy (Decap lo consuma su #/login)
            dispatchLegacyTokenOnly(data);
            // 2) pulisci lâ€™URL ma resta su #/login: Decap poi reindirizza dove serve
            var clean = window.location.pathname + window.location.search.replace(/^\?$/, "") + LOGIN_ROUTE;
            history.replaceState(null, "", clean);
          });
        }

        // Avvio relay al load (Decap giÃ  caricato grazie a defer)
        if (document.readyState === "complete") {
          relayFromUrlIfPresent();
        } else {
          window.addEventListener("load", relayFromUrlIfPresent);
        }

        // Se il popup OAuth invia il messaggio in diretta, porta su #/login e rilancia SOLO {token} con retry
        window.addEventListener("message", function (ev) {
          if (typeof ev.data === "string" && ev.data.indexOf("authorization:github:success:") === 0) {
            try {
              var raw = ev.data.slice("authorization:github:success:".length);
              var obj = JSON.parse(raw || "{}");
              var data = { token: obj && obj.token ? obj.token : null };
              if (!data.token) return;
              ensureLoginRouteThen(function () {
                setTimeout(function () { dispatchLegacyTokenOnly(data); }, 30);
              });
            } catch (_) {}
          }
        });
      })();
    </script>
  </head>
  <body>
    <div id="nc-root"></div>
  </body>
</html>
