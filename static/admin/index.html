<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="description" content="Admin interface - Private area">
    <meta name="referrer" content="same-origin">
    <title>Admin ¬∑ Mini Editor (Hugo + GitHub)</title>
    
    <!-- Styles -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="editor.css">
    <link rel="stylesheet" href="media.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/monokai.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/xml/xml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/yaml/yaml.js"></script>
    
    <!-- App Module Initialization -->
    <script type="module">
        console.log('üöÄ Inizio caricamento moduli admin');
        
        // Import modules
        import { config } from './js/config.js';
        import { auth } from './js/auth.js';
        import { api } from './js/api.js';
        import { items } from './js/items.js';
        import { articles } from './js/articles.js';
        import { ui } from './js/ui.js';
        import { editor } from './js/editor.js';
        import { media } from './js/media.js';
        import { formatDate, slugify, debounce, Storage, validators } from './js/utils.js';
        
        console.log('‚úÖ Tutti i moduli caricati con successo');        // Initialize app on DOM load

        // Initialize app on DOM load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Admin UI inizializzazione iniziata');
            try {
                // Setup UI Templates
                ui.registerTemplate('itemRow', data => `
                    <div class="list-item ${data.draft ? 'draft' : ''}" data-id="${data.id}">
                        <div class="item-main">
                            <input type="checkbox" class="item-checkbox" ${data.selected ? 'checked' : ''} />
                            <div class="item-content">
                                <div class="item-title">${data.title}</div>
                                <div class="item-meta">
                                    <span class="pill">${data.kind}</span>
                                    ${data.draft ? '<span class="pill warning">Bozza</span>' : ''}
                                    <span class="muted">${formatDate(data.date)}</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-edit">Modifica</button>
                    </div>
                `);

                ui.registerTemplate('articleRow', data => `
                    <div class="list-item" data-path="${data.path}">
                        <div class="item-main">
                            <div class="item-content">
                                <div class="item-title">${data.frontmatter.title || 'Senza titolo'}</div>
                                <div class="item-meta">
                                    <span class="muted">${formatDate(data.frontmatter.date)}</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-edit">Modifica</button>
                    </div>
                `);

                // Setup Auth
                const loginBtn = document.getElementById('loginBtn');
                const logoutBtn = document.getElementById('logoutBtn');

                if (!loginBtn || !logoutBtn) {
                    console.error('‚ùå Elementi login/logout non trovati nel DOM');
                    return;
                }

                loginBtn.addEventListener('click', () => auth.login());
                logoutBtn.addEventListener('click', () => auth.logout());

                auth.onAuthStateChanged(user => {
                    console.log('üîê Auth state changed:', user);
                    const who = document.getElementById('who');
                    const lockedOverlay = document.getElementById('lockedOverlay');
                    const adminMain = document.getElementById('adminMain');

                    if (!who || !lockedOverlay || !adminMain) {
                        console.error('‚ùå Elementi UI critici mancanti nel DOM');
                        return;
                    }

                    if (user) {
                        console.log('‚úÖ Utente autenticato:', user.login);
                        who.textContent = user.login;
                        loginBtn.hidden = true;
                        logoutBtn.hidden = false;
                        lockedOverlay.classList.add('hidden');
                        adminMain.classList.remove('hidden');
                        loadContent();
                    } else {
                        console.log('‚ùå Utente non autenticato');
                        who.textContent = '';
                        loginBtn.hidden = false;
                        logoutBtn.hidden = true;
                        lockedOverlay.classList.remove('hidden');
                        adminMain.classList.add('hidden');
                    }
                });

                // View Switching
                const itemsSection = document.getElementById('itemsSection');
                const articlesSection = document.getElementById('articlesSection');
                const viewItemsBtn = document.getElementById('viewItemsBtn');
                const viewArticlesBtn = document.getElementById('viewArticlesBtn');

                if (viewItemsBtn && viewArticlesBtn && itemsSection && articlesSection) {
                    viewItemsBtn.addEventListener('click', () => {
                        viewItemsBtn.classList.add('active');
                        viewArticlesBtn.classList.remove('active');
                        itemsSection.classList.remove('hidden');
                        articlesSection.classList.add('hidden');
                    });

                    viewArticlesBtn.addEventListener('click', async () => {
                        viewArticlesBtn.classList.add('active');
                        viewItemsBtn.classList.remove('active');
                        articlesSection.classList.remove('hidden');
                        itemsSection.classList.add('hidden');

                        // Inizializza editor se non ancora fatto
                        if (!editor.editor) {
                            try {
                                await editor.initialize('a_content', 'preview', 'editorToolbar');
                                console.log('‚úÖ Editor inizializzato con successo');
                            } catch (error) {
                                console.error('‚ùå Errore inizializzazione editor:', error);
                                ui.showToast('Errore inizializzazione editor: ' + error.message, 'error');
                            }
                        }
                    });
                } else {
                    console.warn('‚ö†Ô∏è Elementi view switching non trovati');
                }

                // Items List
                const itemsList = document.getElementById('list');
                const itemSearchInput = document.getElementById('itemSearchInput');
                const itemFilterType = document.getElementById('itemFilterType');
                const itemFilterDraft = document.getElementById('itemFilterDraft');

                const renderItems = () => {
                    if (!itemsList || !itemSearchInput || !itemFilterType || !itemFilterDraft) {
                        console.warn('‚ö†Ô∏è Elementi items list non trovati');
                        return;
                    }

                    const searchTerm = itemSearchInput.value.toLowerCase();
                    const typeFilter = itemFilterType.value;
                    const draftFilter = itemFilterDraft.value;

                    const filteredItems = items.getAllItems().filter(item => {
                        if (searchTerm && !item.title.toLowerCase().includes(searchTerm)) {
                            return false;
                        }
                        if (typeFilter !== 'all' && item.kind !== typeFilter) {
                            return false;
                        }
                        if (draftFilter === 'published' && item.draft) {
                            return false;
                        }
                        if (draftFilter === 'drafts' && !item.draft) {
                            return false;
                        }
                        return true;
                    });

                    itemsList.innerHTML = filteredItems
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .map(item => ui.render('itemRow', item))
                        .join('');
                };

                const debouncedRenderItems = debounce(renderItems, 300);

                if (itemSearchInput) itemSearchInput.addEventListener('input', debouncedRenderItems);
                if (itemFilterType) itemFilterType.addEventListener('change', renderItems);
                if (itemFilterDraft) itemFilterDraft.addEventListener('change', renderItems);

                // Item Form
                const itemForm = {
                    date: document.getElementById('f_date'),
                    title: document.getElementById('f_title'),
                    slug: document.getElementById('f_slug'),
                    kind: document.getElementById('f_kind'),
                    overline: document.getElementById('f_overline'),
                    author: document.getElementById('f_author'),
                    id: document.getElementById('f_id'),
                    thumb: document.getElementById('f_thumb'),
                    desc: document.getElementById('f_desc'),
                    tags: document.getElementById('f_tags'),
                    draft: document.getElementById('f_draft'),
                    updated: document.getElementById('f_updated'),
                    card: document.getElementById('f_card'),
                    raw: document.getElementById('f_raw')
                };

                const clearItemForm = () => {
                    Object.values(itemForm).forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                };

                const loadItemIntoForm = (item) => {
                    itemForm.date.value = formatDate(item.date);
                    itemForm.title.value = item.title || '';
                    itemForm.slug.value = item.slug || '';
                    itemForm.kind.value = item.kind || '';
                    itemForm.overline.value = item.overline || '';
                    itemForm.author.value = item.author || '';
                    itemForm.id.value = item.id || '';
                    itemForm.thumb.value = item.thumb || '';
                    itemForm.desc.value = item.desc || '';
                    itemForm.tags.value = (item.tags || []).join(', ');
                    itemForm.draft.checked = item.draft || false;
                    itemForm.updated.value = item.updated ? formatDate(item.updated, 'YYYY-MM-DDTHH:mm') : '';
                    itemForm.card.value = item.card || '';
                    itemForm.raw.value = jsyaml.dump(item);
                };

                // Save Item
                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', async () => {
                    try {
                        ui.showLoading('saveBtn');
                        
                        const formData = {
                            date: itemForm.date.value,
                            title: itemForm.title.value,
                            slug: itemForm.slug.value || slugify(itemForm.title.value),
                            kind: itemForm.kind.value,
                            overline: itemForm.overline.value,
                            author: itemForm.author.value,
                            id: itemForm.id.value || itemForm.slug.value,
                            thumb: itemForm.thumb.value,
                            desc: itemForm.desc.value,
                            tags: itemForm.tags.value.split(',').map(t => t.trim()).filter(Boolean),
                            draft: itemForm.draft.checked,
                            updated: itemForm.updated.value,
                            card: itemForm.card.value
                        };

                        await items.saveItem(formData);
                        
                        ui.showToast('Item salvato con successo', 'success');
                        renderItems();
                    } catch (error) {
                        ui.showToast(error.message, 'error');
                    } finally {
                        ui.hideLoading('saveBtn');
                    }
                    });
                } else {
                    console.warn('‚ö†Ô∏è Pulsante save non trovato');
                }

                // Articles List
                const articlesList = document.getElementById('articlesList');
                
                const renderArticles = () => {
                    articlesList.innerHTML = articles.getAllArticles()
                        .sort((a, b) => new Date(b.frontmatter.date) - new Date(a.frontmatter.date))
                        .map(article => ui.render('articleRow', article))
                        .join('');
                };

                // Load Content
                async function loadContent() {
                    console.log('üìÇ Caricamento contenuto iniziato');
                    try {
                        // Non usare showLoading su adminMain perch√© cancellerebbe il contenuto HTML
                        // Mostra un loader specifico invece
                        const buildNotice = document.getElementById('buildNotice');
                        if (buildNotice) {
                            buildNotice.classList.remove('hidden');
                            buildNotice.querySelector('.msg').textContent = 'Caricamento dati...';
                        }

                        await Promise.all([
                            items.initialize(),
                            articles.initialize(),
                            media.initialize() // Media manager inizializzer√† lazy quando necessario
                        ]);

                        console.log('üìÇ Moduli inizializzati');

                        // L'editor verr√† inizializzato quando si accede alla sezione articoli

                        renderItems();
                        renderArticles();

                        console.log('üìÇ Rendering completato');

                        // Mostra elementi UI con controllo null-safety
                        const viewRow = document.getElementById('viewRow');
                        const actionsRow = document.getElementById('actionsRow');
                        const articleActionsRow = document.getElementById('articleActionsRow');
                        const itemsSection = document.getElementById('itemsSection');

                        if (viewRow) viewRow.classList.remove('hidden');
                        if (actionsRow) actionsRow.classList.remove('hidden');
                        if (articleActionsRow) articleActionsRow.classList.remove('hidden');
                        if (itemsSection) itemsSection.classList.remove('hidden');

                        console.log('‚úÖ Admin UI completamente caricata');
                    } catch (error) {
                        console.error('‚ùå Errore caricamento contenuto:', error);
                        ui.showToast(error.message, 'error');
                    } finally {
                        // Nascondi loader
                        const buildNotice = document.getElementById('buildNotice');
                        if (buildNotice) {
                            buildNotice.classList.add('hidden');
                        }
                    }
                }

                // Error Handling
                window.addEventListener('unhandledrejection', event => {
                    ui.showToast(event.reason.message, 'error');
                });

            } catch (error) {
                console.error('‚ùå Errore inizializzazione admin:', error);
                ui.showToast('Errore di inizializzazione: ' + error.message, 'error');
                // Prova a mostrare almeno il login
                const lockedOverlay = document.getElementById('lockedOverlay');
                if (lockedOverlay) {
                    lockedOverlay.classList.remove('hidden');
                }
            }
        });
    </script>
</head>
<body>
    <!-- Skip Links -->
    <a href="#main-content" class="skip-link">Vai al contenuto principale</a>
    <a href="#itemsSection" class="skip-link">Vai alla lista items</a>

    <div class="wrap">
        <div id="buildNotice" class="notice hidden" role="status" aria-live="polite">
            <span class="spinner" aria-hidden="true"></span>
            <span class="msg">Build in corso‚Ä¶</span>
        </div>

        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container" role="region" aria-live="polite" aria-label="Notifiche"></div>

        <header>
            <div class="row" id="authRow">
                <button id="loginBtn" class="btn primary">Login con GitHub</button>
                <button id="logoutBtn" class="btn" hidden>Logout</button>
                <span id="who" class="status"></span>
            </div>
            <div class="row hidden" id="viewRow">
                <button id="viewItemsBtn" class="btn btn-tab active">Archivio</button>
                <button id="viewArticlesBtn" class="btn btn-tab">Articoli</button>
            </div>
            <div class="row hidden" id="actionsRow">
                <button id="newBtn" class="btn">Nuovo item</button>
                <button id="saveBtn" class="btn primary">Salva</button>
                <button id="multiBtn" class="btn">Seleziona multipli</button>
                <button id="deleteSelectedBtn" class="btn danger hidden" disabled>Elimina selezionati</button>
                <span id="saveStatus" class="status"></span>
            </div>
            <div class="row hidden" id="articleActionsRow">
                <button id="newArticleBtn" class="btn">Nuovo articolo</button>
                <button id="saveArticleBtn" class="btn primary">Salva articolo</button>
                <button id="deleteArticleBtn" class="btn danger" disabled>Elimina articolo</button>
                <span id="articleStatus" class="status"></span>
            </div>
        </header>

        <div id="lockedOverlay" class="card login-guard">
            <strong>Accesso richiesto</strong>
            <p class="muted">Effettua il login con GitHub per utilizzare l'editor.</p>
        </div>

        <div id="adminMain" class="hidden">
            <div id="itemsSection" class="grid hidden">
                <div class="card">
                    <div class="row justify-between mb-8">
                        <div>
                            <strong>Archivio - Items</strong>
                            <div class="muted">folder: <code>data/archive/items</code> - branch: <code>main</code></div>
                        </div>
                        <button id="reloadBtn" class="btn">Reload</button>
                    </div>
                    <div class="row mb-8" style="gap:8px;">
                        <input type="text" id="itemSearchInput" placeholder="üîç Cerca items..." style="flex:1;min-width:0;" />
                        <select id="itemFilterType" style="width:auto;">
                            <option value="all">Tutti i tipi</option>
                            <option value="video">Video</option>
                            <option value="content">Content</option>
                        </select>
                        <select id="itemFilterDraft" style="width:auto;">
                            <option value="all">Tutti</option>
                            <option value="published">Pubblicati</option>
                            <option value="drafts">Solo bozze</option>
                        </select>
                    </div>
                    <div id="list" class="list"></div>
                </div>

                <div class="card">
                    <div class="two mt-8">
                        <div>
                            <label>Data</label>
                            <input id="f_date" type="date" />
                        </div>
                        <div>
                            <label>Titolo</label>
                            <input id="f_title" type="text" placeholder="Titolo" />
                        </div>
                    </div>

                    <div class="two mt-8">
                        <div>
                            <label>Slug (kebab-case)</label>
                            <input id="f_slug" type="text" placeholder="es. nuova-carta-xyz" />
                        </div>
                        <div>
                            <label>Tipo</label>
                            <input id="f_kind" type="text" placeholder="video | content" />
                        </div>
                    </div>

                    <div class="two mt-8">
                        <div>
                            <label>Overline</label>
                            <input id="f_overline" type="text" />
                        </div>
                        <div>
                            <label>Autore</label>
                            <input id="f_author" type="text" />
                        </div>
                    </div>

                    <div class="two mt-8">
                        <div>
                            <label>ID</label>
                            <input id="f_id" type="text" placeholder="opzionale (fallback: slug)" />
                        </div>
                        <div>
                            <label>Thumbnail</label>
                            <div class="row align-center gap-8">
                                <input id="f_thumb" type="text" placeholder="/images/thumbs/... oppure URL" />
                                <input id="uploadThumb" type="file" accept="image/*" hidden />
                                <button id="btnUploadThumb" class="btn">Carica</button>
                                <button id="btnBrowseThumb" class="btn">Sfoglia</button>
                            </div>
                            <div id="thumbBrowser" class="asset-browser hidden"></div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <label>Descrizione</label>
                        <textarea id="f_desc" class="textarea--sm" placeholder="Testo descrizione (opzionale)"></textarea>
                    </div>

                    <div class="two mt-8">
                        <div>
                            <label>Tag (separati da virgola)</label>
                            <input id="f_tags" type="text" placeholder="es. commander, edh, guide" />
                            <div id="tagsSaved" class="tags-saved mt-8"></div>
                        </div>
                        <div class="switch-row">
                            <div class="switch-pair">
                                <label for="f_draft">Bozza</label>
                                <input id="f_draft" type="checkbox" />
                            </div>
                            <div class="switch-pair">
                                <label for="f_updated">Aggiornato</label>
                                <input id="f_updated" type="datetime-local" />
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <label>Immagine Card (home)</label>
                        <div class="row align-center gap-8">
                            <input id="f_card" type="text" placeholder="/images/cards/... oppure URL" />
                            <input id="uploadCard" type="file" accept="image/*" hidden />
                            <button id="btnUploadCard" class="btn">Carica</button>
                            <button id="btnBrowseCard" class="btn">Sfoglia</button>
                        </div>
                        <div id="cardBrowser" class="asset-browser hidden"></div>
                    </div>

                    <div style="margin-top:8px">
                        <label>YAML grezzo (avanzato)</label>
                        <textarea id="f_raw" placeholder="# qui vedi/modifichi l'intero YAML"></textarea>
                        <div class="muted">Puoi editare i campi sopra o direttamente il YAML. Al salvataggio unifichiamo.</div>
                    </div>

                    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
                        <span id="fileInfo" class="pill">-</span>
                        <button id="deleteBtn" class="btn danger">Elimina</button>
                    </div>
                </div>
            </div>

            <div id="articlesSection" class="grid hidden">
                <div class="card">
                    <div class="row justify-between mb-8">
                        <div>
                            <strong>Elenco Articoli</strong>
                            <div class="muted">folder: <code>content/article</code> - branch: <code>main</code></div>
                        </div>
                        <button id="reloadArticlesBtn" class="btn">Reload</button>
                    </div>
                    <div id="articlesList" class="list"></div>
                </div>

                <div class="card">
                    <div class="mt-8">
                        <label>Titolo</label>
                        <input id="a_title" type="text" placeholder="Titolo articolo" />
                    </div>

                    <div class="two mt-8">
                        <div>
                            <label>Data</label>
                            <input id="a_date" type="date" />
                        </div>
                        <div>
                            <label>Autore</label>
                            <input id="a_author" type="text" />
                        </div>
                    </div>

                    <div class="mt-8">
                        <label>Contenuto (Markdown)</label>
                        <div class="editor-container">
                            <div class="editor-section">
                                <div class="editor-toolbar" id="editorToolbar">
                                    <button class="editor-btn" title="Grassetto (Ctrl+B)" data-md="bold">
                                        <span class="material-icons">format_bold</span>
                                    </button>
                                    <button class="editor-btn" title="Corsivo (Ctrl+I)" data-md="italic">
                                        <span class="material-icons">format_italic</span>
                                    </button>
                                    <button class="editor-btn" title="Link (Ctrl+L)" data-md="link">
                                        <span class="material-icons">link</span>
                                    </button>
                                    <button class="editor-btn" title="Immagine" data-md="image">
                                        <span class="material-icons">image</span>
                                    </button>
                                    <button class="editor-btn" title="Codice (Ctrl+K)" data-md="code">
                                        <span class="material-icons">code</span>
                                    </button>
                                    <button class="editor-btn" title="Citazione" data-md="quote">
                                        <span class="material-icons">format_quote</span>
                                    </button>
                                    <button class="editor-btn" title="Lista puntata" data-md="ul">
                                        <span class="material-icons">format_list_bulleted</span>
                                    </button>
                                    <button class="editor-btn" title="Lista numerata" data-md="ol">
                                        <span class="material-icons">format_list_numbered</span>
                                    </button>
                                    <button class="editor-btn" title="Titolo H2" data-md="h2">
                                        <span class="material-icons">title</span>
                                    </button>
                                    <button class="editor-btn" title="Blocco codice" data-md="codeblock">
                                        <span class="material-icons">code_blocks</span>
                                    </button>
                                </div>
                                <textarea id="a_content" placeholder="Contenuto articolo in formato Markdown"></textarea>
                            </div>
                            <div class="preview-container">
                                <div id="preview" class="preview"></div>
                            </div>
                        </div>
                        <div class="autosave-indicator" id="autosaveIndicator">
                            Salvataggio automatico...
                        </div>
                    </div>

                    <div class="mt-8">
                        <label>Tag (separati da virgola)</label>
                        <input id="a_tags" type="text" placeholder="es. news, guida, altro" />
                    </div>

                    <div class="mt-8">
                        <label>Categorie (separati da virgola)</label>
                        <input id="a_categories" type="text" placeholder="es. news, guide" />
                    </div>

                    <div class="switch-row mt-8">
                        <div class="switch-pair">
                            <label for="a_draft">Bozza</label>
                            <input id="a_draft" type="checkbox" />
                        </div>
                        <div class="switch-pair">
                            <label for="a_featured">In evidenza</label>
                            <input id="a_featured" type="checkbox" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>