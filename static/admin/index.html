<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EventHorizon Admin</title>

    <!-- Favicon per silenziare 404 (opzionale) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>🔒</text></svg>">

    <!-- Listener PRECOCE: prima di caricare Decap, così non perdiamo il postMessage -->
    <script>
      (function () {
        // Accoda i payload ricevuti finché Decap non è pronto
        window.__oauthQueue = [];

        function isAuthMsg(s) {
          return typeof s === "string" && (
            s.startsWith("authorization:github:success:") ||
            s.startsWith("authorization:github:error:")
          );
        }

        function enqueue(msg) {
          try { window.__oauthQueue.push(String(msg)); } catch(_) {}
        }

        // 1) Ascolta postMessage dal popup (o da altre finestre)
        window.addEventListener("message", function (e) {
          if (!e || typeof e.data !== "string") return;
          if (!isAuthMsg(e.data)) return;
          enqueue(e.data);
        }, false);

        // 2) Leggi fallback via HASH o QUERY (se presente)
        function takeFromUrl() {
          var raw = location.hash ? decodeURIComponent(location.hash.slice(1)) : "";
          if (!raw && location.search) {
            var q = new URLSearchParams(location.search);
            raw = q.get("authorization") || "";
          }
          if (isAuthMsg(raw)) enqueue(raw);
        }
        takeFromUrl();

        // 3) Dispatcher che riprova finché Decap non “aggancia”
        function flushQueue() {
          if (!window.__oauthQueue || !window.__oauthQueue.length) return;
          try {
            var copy = window.__oauthQueue.slice();
            window.__oauthQueue.length = 0;
            copy.forEach(function (m) {
              // Re-post localmente (origin corretto)
              window.postMessage(m, window.location.origin);
            });
          } catch(_) {}
        }

        // Ripeti flush alcune volte per coprire race (router mount, ecc.)
        var tries = 0, maxTries = 20;
        var iv = setInterval(function () {
          flushQueue();
          tries++;
          if (tries >= maxTries) clearInterval(iv);
        }, 150);

        // Pulisci URL dopo un po' (ma non subito, per consentire a Decap di leggerlo)
        setTimeout(function () {
          var raw = location.hash ? decodeURIComponent(location.hash.slice(1)) : "";
          if (raw && isAuthMsg(raw)) {
            history.replaceState(null, "", location.pathname);
          }
        }, 2000);
      })();
    </script>

    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.8.3/dist/decap-cms.js" defer></script>

    <!-- (Opzionale) Log di debug sintetico -->
    <script defer>
      window.addEventListener("message", function (e) {
        var d = e && e.data;
        if (typeof d === "string" && d.startsWith("authorization:github:")) {
          // console.log("[bridge] received:", d.slice(0, 80) + "…");
        }
      });
    </script>
  </head>
  <body>
    <script>
      // Inizializzazione Decap: chiamarla ESATTAMENTE una volta
      (function () {
        var inited = false;

        function initOnce() {
          if (inited) return;
          if (!(window.CMS && typeof window.CMS.init === "function")) return;
          inited = true;
          window.CMS.init();
        }

        // 1) Prova subito (se Decap è già caricato)
        initOnce();

        // 2) Poll leggero per quando lo script defer finisce dopo
        var tries = 0, maxTries = 40;
        var poll = setInterval(function () {
          if (inited) { clearInterval(poll); return; }
          initOnce();
          tries++;
          if (inited || tries >= maxTries) clearInterval(poll);
        }, 100);

        // 3) Ulteriore safety su DOMContentLoaded
        document.addEventListener("DOMContentLoaded", initOnce);
        window.addEventListener("load", initOnce);
      })();
    </script>
  </body>
</html>
