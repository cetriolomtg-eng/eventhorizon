<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin · Decap CMS</title>
    <!-- Evita auto-init e doppie inizializzazioni -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <!-- UNA SOLA copia di Decap CMS -->
    <script src="https://unpkg.com/decap-cms@3.8.3/dist/decap-cms.js"></script>
    <style>
      html,body {
        height:100%;
        margin:0;
        background:#0e0f1a;
        color:#eaeef8;
        font-family:system-ui, sans-serif;
      }
      .nc-appHeader-root {
        background: rgba(47,39,96,.9);
        backdrop-filter: blur(6px);
      }
    </style>
  </head>
  <body>
    <noscript>Serve JavaScript per usare l’admin.</noscript>

    <script>
      // Log errori JS globali
      window.addEventListener('error', e => console.error('[ADMIN error]', e.error || e.message));
      window.addEventListener('unhandledrejection', e => console.error('[ADMIN unhandled]', e.reason));

      // Attiva log verbosi di Decap
      try { localStorage.setItem('debug','decap-cms:*'); } catch {}

      // Init esplicito Decap CMS al DOM ready
      window.addEventListener('DOMContentLoaded', async () => {
        const cfgUrl = '/admin/config.yml';
        const r = await fetch(cfgUrl, { cache: 'no-store' });
        if (!r.ok) {
          console.error('[ADMIN] Config non raggiungibile:', r.status, cfgUrl);
          alert('Config non trovata: ' + cfgUrl + ' (HTTP ' + r.status + ')');
          return;
        }
        CMS.init({ config: cfgUrl });
        console.log('[ADMIN] Decap avviato con', cfgUrl);
      });

      // --- Patch permanente: salva token OAuth in localStorage ---
      (function () {
        const KEYS = [
          'decap-cms-user',     // nuovo Decap CMS
          'netlify-cms-user'    // compat col vecchio Netlify CMS
        ];
        function saveToken(token) {
          if (!token) return;
          const payload = JSON.stringify({ token: String(token) });
          for (const k of KEYS) localStorage.setItem(k, payload);
          console.log('[ADMIN] Token salvato in', KEYS, '→ ricarico…');
          // Ricarico per far rileggere a Decap l’auth
          setTimeout(() => location.reload(), 150);
        }
        window.addEventListener('message', (e) => {
          if (typeof e.data !== 'string') return;
          if (e.data.startsWith('authorization:github:success:')) {
            const token = e.data.slice('authorization:github:success:'.length);
            console.log('[ADMIN] Hook OAuth → token length:', token.length);
            saveToken(token);
          }
        });
      })();
    </script>
  </body>
</html>
