<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin · CMS</title>

    <!-- Evita auto-init -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <!-- Build stabile (Netlify CMS app 2.10.x) -->
    <script src="https://unpkg.com/netlify-cms-app@2.15.72/dist/netlify-cms.js"></script>

    <style>
      html,body{height:100%;margin:0;background:#0e0f1a;color:#eaeef8;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
      .nc-appHeader-root{background:rgba(47,39,96,.9);backdrop-filter:blur(6px)}
    </style>
  </head>
  <body>
    <noscript>Serve JavaScript per usare l’admin.</noscript>

    <script>
      // Log utili
      window.addEventListener('error', e => console.error('[ADMIN error]', e.error || e.message));
      window.addEventListener('unhandledrejection', e => console.error('[ADMIN unhandled]', e.reason));

      // Config INLINE (identica alla tua), niente fetch di YAML
      const config = {
        load_config_file: false,
        backend: {
          name: "github",
          repo: "eventhorizon-mtg/eventhorizon-mtg.github.io",
          branch: "test",
          base_url: "https://eventhorizon-oauth.cetriolo-mtg.workers.dev",
          auth_endpoint: "auth",
          app_id: "INSERISCI_IL_TUO_CLIENT_ID_GITHUB" // <-- Client ID reale
        },
        media_folder: "static/uploads",
        public_folder: "/uploads",
        locale: "it",
        collections: [
          {
            name: "archive_items",
            label: "Archivio — Items",
            folder: "data/archive/items",
            create: true,
            format: "yaml",
            extension: "yml",
            slug: "{{slug}}",
            fields: [
              { label: "Data", name: "date", widget: "date", format: "YYYY-MM-DD", required: true },
              { label: "Titolo", name: "title", widget: "string", required: true },
              { label: "ID", name: "id", widget: "string", required: false },
              { label: "Slug", name: "slug", widget: "string", required: false,
                pattern: ["^[a-z0-9]+(?:-[a-z0-9]+)*$", "Minuscole, numeri e trattini (kebab-case)."] },
              { label: "Tipo", name: "kind", widget: "select",
                options: [{ label: "Video", value: "video" }, { label: "Contenuto", value: "content" }],
                required: false, default: "content" },
              { label: "Overline", name: "overline", widget: "string", required: false },
              { label: "Descrizione", name: "desc", widget: "text", required: false },
              { label: "Thumbnail", name: "thumb", widget: "image", required: false, choose_url: true },
              { label: "Tag", name: "tags", widget: "list", required: false,
                field: { label: "Tag", name: "tag", widget: "string" } },
              { label: "Link", name: "links", widget: "list", required: false, fields: [
                { label: "Label", name: "label", widget: "string", required: false },
                { label: "URL", name: "href", widget: "string", required: false,
                  pattern: ["^https?://.*", "Inserisci un URL assoluto (http/https)."] },
                { label: "Classe bottone", name: "btn_class", widget: "string", required: false },
                { label: "Ordine", name: "sort_order", widget: "number", required: false, default: 0 },
                { label: "Primario", name: "primary", widget: "boolean", required: false, default: false }
              ]},
              { label: "Bozza", name: "draft", widget: "boolean", required: false, default: false },
              { label: "Autore", name: "author", widget: "string", required: false },
              { label: "Aggiornato", name: "updated", widget: "datetime", required: false }
            ]
          }
        ]
      };

      // Inizializza
      window.addEventListener('DOMContentLoaded', () => {
        CMS.init({ config });
        console.log('[ADMIN] CMS avviato (build stabile)');
      });

      // Logout helper (se serve forzare)
      // localStorage.removeItem('netlify-cms-user'); sessionStorage.clear();

      // Hook: se il popup manda il token, salva e ricarica
      (function () {
        async function buildUserPayload(token) {
          const headers = { Authorization: 'token ' + token, Accept: 'application/vnd.github+json' };
          let userJson = null;
          try { const me = await fetch('https://api.github.com/user', { headers }); if (me.ok) userJson = await me.json(); } catch {}
          return JSON.stringify(userJson ? { token: String(token), user: userJson } : { token: String(token) });
        }
        window.addEventListener('message', async (e) => {
          if (typeof e.data !== 'string') return;
          if (e.data.startsWith('authorization:github:success:')) {
            const token = e.data.slice('authorization:github:success:'.length);
            if (!token) return;
            const payloadStr = await buildUserPayload(token);
            // Chiave che questa build consulta: netlify-cms-user
            localStorage.setItem('netlify-cms-user', payloadStr);
            console.log('[ADMIN] Token salvato → reload');
            setTimeout(()=>location.reload(), 100);
          }
        });
      })();
    </script>
  </body>
</html>
