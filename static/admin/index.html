<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <!-- Root element per Decap CMS -->
  <div id="nc-root"></div>

  <!-- Carica Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <script>
    console.log('üîµ Decap CMS - Pagina caricata');

    // Verifica se c'√® gi√† un token salvato
    const savedUser = localStorage.getItem('netlify-cms-user');
    if (savedUser) {
      const userData = JSON.parse(savedUser);
      console.log('‚úÖ Token trovato in localStorage:', userData.login);
      console.log('üìã Contenuto completo:', userData);

      // Verifica che il token sia valido
      if (!userData.token) {
        console.error('‚ùå Token mancante nel localStorage! Rimuovo dati corrotti...');
        localStorage.removeItem('netlify-cms-user');
      }
    } else {
      console.log('‚ö†Ô∏è Nessun token in localStorage - login necessario');
    }

    // DEBUG: mostra TUTTO il localStorage
    console.log('üóÑÔ∏è Contenuto completo localStorage:');
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      console.log(`  - ${key}:`, localStorage.getItem(key));
    }

    // OAuth message handler per gestire il token dal worker OAuth
    window.addEventListener('message', (event) => {
      console.log('üì® Messaggio ricevuto:', event.origin, event.data);

      if (event.origin === 'https://eventhorizon-oauth.cetriolo-mtg.workers.dev') {
        if (typeof event.data === 'string' && event.data.startsWith('authorization:github:success:')) {
          const token = event.data.slice('authorization:github:success:'.length);
          console.log('üîë Token OAuth ricevuto');

          // Valida e salva il token
          fetch('https://api.github.com/user', {
            headers: { 'Authorization': `token ${token}` }
          })
          .then(r => r.json())
          .then(user => {
            console.log('‚úÖ Token validato per utente:', user.login);

            localStorage.setItem('netlify-cms-user', JSON.stringify({
              token: token,
              login: user.login,
              name: user.name || user.login,
              avatar_url: user.avatar_url,
              backendName: 'github'
            }));

            console.log('üíæ Token salvato - ricarico pagina...');
            // Ricarica per inizializzare il CMS con il token
            window.location.reload();
          })
          .catch(e => {
            console.error('‚ùå Errore validazione token:', e);
          });
        }
      }
    });

    // Monitor quando il CMS si inizializza
    window.addEventListener('load', () => {
      console.log('üöÄ Window load event - CMS dovrebbe auto-inizializzarsi');

      // Attendi che il CMS sia pronto e forza il login se abbiamo un token
      setTimeout(() => {
        if (window.CMS) {
          console.log('‚úÖ window.CMS disponibile');

          // Se abbiamo un token salvato, prova a forzare l'autenticazione
          const savedUser = localStorage.getItem('netlify-cms-user');
          if (savedUser) {
            const userData = JSON.parse(savedUser);
            console.log('üîê Tentativo di autenticazione manuale con token salvato...');

            try {
              // Prova a impostare manualmente l'utente autenticato
              // Decap CMS potrebbe usare chiavi diverse
              const authData = {
                token: userData.token,
                backendName: 'github'
              };

              // Salva in tutti i formati possibili che Decap potrebbe cercare
              localStorage.setItem('decap-cms-user', JSON.stringify(userData));
              localStorage.setItem('netlify-cms-user', JSON.stringify(userData));

              // Salva anche il formato "vecchio" di Netlify CMS
              localStorage.setItem('netlify-cms-auth', JSON.stringify({
                github: {
                  token: userData.token
                }
              }));

              console.log('üíæ Token salvato in formati multipli - ricarico...');

              // Ricarica una sola volta per applicare
              if (!sessionStorage.getItem('cms-reload-done')) {
                sessionStorage.setItem('cms-reload-done', 'true');
                window.location.reload();
              }
            } catch (e) {
              console.error('‚ùå Errore durante autenticazione manuale:', e);
            }
          }
        } else {
          console.error('‚ùå window.CMS NON trovato!');
        }

        // Verifica se il root ha contenuto
        const root = document.getElementById('nc-root');
        if (root && root.children.length > 0) {
          console.log('‚úÖ CMS renderizzato - elementi nel DOM:', root.children.length);
        } else {
          console.error('‚ùå CMS NON renderizzato - #nc-root vuoto!');
        }
      }, 2000);
    });
  </script>
</body>
</html>