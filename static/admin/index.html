<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    console.log('üîç Decap CMS - versione pulita');
    
    // Gestione OAuth semplificata
    window.addEventListener('message', (event) => {
      if (event.origin === 'https://eventhorizon-oauth.cetriolo-mtg.workers.dev') {
        if (typeof event.data === 'string' && event.data.startsWith('authorization:github:success:')) {
          const token = event.data.slice('authorization:github:success:'.length);
          console.log('‚úÖ Token ricevuto:', token);
          
          // TEST IMMEDIATO TOKEN GITHUB
          fetch('https://api.github.com/user', {
            headers: { 'Authorization': `token ${token}` }
          })
          .then(r => r.json())
          .then(user => {
            console.log('üë§ GitHub user:', user.login);
            
            // Salva con username REALE da GitHub
            localStorage.setItem('netlify-cms-user', JSON.stringify({
              token: token,
              login: user.login, // Username VERO da GitHub API
              name: user.name || user.login,
              avatar_url: user.avatar_url,
              backendName: 'github'
            }));
            
            console.log('üíæ Token salvato per:', user.login);
            window.location.reload();
          })
          .catch(e => {
            console.error('‚ùå Token invalido:', e);
            alert('Token GitHub non valido!');
          });
        }
      }
    });
    
    // Inizializzazione Decap CMS con forced init (dalla nostra deep analysis)
    window.addEventListener('load', () => {
      setTimeout(() => {
        console.log('üîç Stato Decap CMS:');
        console.log('- window.CMS:', !!window.CMS);
        console.log('- Token presente:', !!localStorage.getItem('netlify-cms-user'));
        
        // Lasciamo che Decap CMS si inizializzi naturalmente
        console.log('‚è≥ Aspettando inizializzazione naturale di Decap CMS...');
        
        // Test diagnostico per config.yml
        console.log('üîç Test caricamento config.yml...');
        fetch('./config.yml')
          .then(response => {
            console.log('üìÑ Config.yml response:', response.status, response.statusText);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.text();
          })
          .then(yamlText => {
            console.log('üìù Config.yml caricato:', yamlText.length, 'caratteri');
            console.log('üìù Prime 3 righe:', yamlText.split('\n').slice(0, 3).join('\n'));
            
            // Test parsing YAML
            try {
              // Decap uses js-yaml internally, let's try to parse manually
              console.log('üîç Test parsing YAML...');
              // We can't access js-yaml directly, but we can check for obvious issues
              if (yamlText.includes('\t')) {
                console.warn('‚ö†Ô∏è YAML contiene TAB - potrebbero causare problemi');
              }
              if (yamlText.includes('‚Äî') || yamlText.includes('"') || yamlText.includes('"')) {
                console.warn('‚ö†Ô∏è YAML contiene caratteri Unicode - potrebbero causare problemi');
              }
              console.log('‚úÖ Test YAML preliminare OK');
            } catch (e) {
              console.error('‚ùå Errore test YAML:', e);
            }
          })
          .catch(error => {
            console.error('‚ùå Errore caricamento config.yml:', error);
          });
        
        // Check finale dello stato con retry per aspettare config loading
        function checkFinalState(attempt = 1, maxAttempts = 10) {
          setTimeout(() => {
            const config = window.CMS && window.CMS.getConfig ? window.CMS.getConfig() : null;
            console.log(`üìä Check ${attempt}: CMS config disponibile:`, !!config);
            
            const hasLoginButton = !!document.querySelector('button[type="button"]');
            console.log(`üîê Check ${attempt}: Login UI visibile:`, hasLoginButton);
            
            if (config && !hasLoginButton) {
              console.log('üéâ SUCCESS: Decap CMS completamente caricato e autenticato!');
            } else if (attempt < maxAttempts) {
              console.log(`‚è≥ Retry ${attempt + 1}/${maxAttempts}...`);
              checkFinalState(attempt + 1, maxAttempts);
            } else {
              console.log('‚ö†Ô∏è Config non caricata dopo 10 tentativi - provo inizializzazione manuale');
              
              // Ultimo tentativo: carica config manualmente e inizializza
              fetch('./config.yml')
                .then(response => response.text())
                .then(yamlText => {
                  console.log('üîÑ Tentativo inizializzazione manuale con config inline...');
                  
                  // Parse YAML manually (basic parsing for this specific config)
                  const config = {
                    backend: {
                      name: 'github',
                      repo: 'eventhorizon-mtg/eventhorizon-mtg.github.io',
                      branch: 'main',
                      base_url: 'https://eventhorizon-oauth.cetriolo-mtg.workers.dev',
                      auth_endpoint: '/auth'
                    },
                    media_folder: 'static/uploads',
                    public_folder: '/uploads',
                    collections: [{
                      name: 'items',
                      label: 'Archivio Items',
                      folder: 'data/archive/items',
                      create: true,
                      format: 'yaml',
                      extension: 'yml',
                      slug: '{{slug}}',
                      fields: [
                        { label: 'Data', name: 'date', widget: 'date', required: true },
                        { label: 'Titolo', name: 'title', widget: 'string', required: true }
                      ]
                    }]
                  };
                  
                  if (window.CMS && window.CMS.init) {
                    try {
                      window.CMS.init({ config });
                      console.log('‚úÖ Inizializzazione manuale completata');
                    } catch (e) {
                      console.error('‚ùå Errore inizializzazione manuale:', e);
                    }
                  }
                })
                .catch(e => console.error('‚ùå Errore caricamento per init manuale:', e));
            }
          }, 1000);
        }
        
        checkFinalState();
        
      }, 3000);
    });
  </script>
</body>
</html>