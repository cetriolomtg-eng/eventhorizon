<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <script>
    console.log('üîç Decap CMS loading (minimal version)...');
    
    // Intercetta messaggi OAuth e salva in localStorage
    window.addEventListener('message', (event) => {
      console.log('üì® Message received:', event.origin, event.data);
      
      if (event.origin === 'https://eventhorizon-oauth.cetriolo-mtg.workers.dev') {
        if (typeof event.data === 'string' && event.data.startsWith('authorization:github:success:')) {
          const token = event.data.slice('authorization:github:success:'.length);
          console.log('‚úÖ Token OAuth ricevuto:', token);
          
          // Salva il token nel formato che Decap CMS si aspetta
          const userObj = {
            token: token,
            login: 'github-user',
            name: 'GitHub User',
            avatar_url: 'https://github.com/github.png',
            id: 1
          };
          
          localStorage.setItem('netlify-cms-user', JSON.stringify(userObj));
          
          // Prova anche altri formati che Decap CMS potrebbe riconoscere
          localStorage.setItem('github_token', token);
          sessionStorage.setItem('netlify-cms-user', JSON.stringify(userObj));
          
          console.log('üíæ Token salvato, ricaricamento...');
          window.location.reload();
        }
      }
    });
    
    // Log del token esistente
    const savedUser = localStorage.getItem('netlify-cms-user');
    if (savedUser) {
      console.log('üë§ Token esistente:', JSON.parse(savedUser));
    }
    
    // Debug di Decap CMS
    window.addEventListener('load', () => {
      console.log('‚úÖ Page loaded');
      
      setTimeout(() => {
        console.log('üîç Checking Decap CMS status...');
        console.log('- window.CMS:', !!window.CMS);
        console.log('- document.body.innerHTML length:', document.body.innerHTML.length);
        console.log('- #nc-root exists:', !!document.getElementById('nc-root'));
        
        // Controlla se ci sono errori nella console
        const originalError = console.error;
        console.error = function(...args) {
          console.log('üö® CONSOLE ERROR:', ...args);
          originalError.apply(console, args);
        };
        
        // Prova a fare un fetch del config.yml per vedere se √® accessibile
        fetch('./config.yml')
          .then(response => {
            console.log('üìã config.yml response status:', response.status);
            if (response.ok) {
              return response.text();
            } else {
              throw new Error('Config file not found');
            }
          })
          .then(configText => {
            console.log('‚úÖ config.yml content length:', configText.length);
            console.log('üìã config.yml first 200 chars:', configText.substring(0, 200));
          })
          .catch(error => {
            console.error('‚ùå Error loading config.yml:', error);
          });
          
        // Se CMS √® disponibile, prova a ottenere informazioni su di esso
        if (window.CMS) {
          console.log('CMS methods available:', Object.keys(window.CMS));
          
          // Prova a ottenere la configurazione
          try {
            const config = window.CMS.getConfig && window.CMS.getConfig();
            console.log('CMS config:', config);
          } catch (e) {
            console.log('Error getting CMS config:', e);
          }
        }
        
      }, 3000);
    });
  </script>
  
  <!-- Root element per Decap CMS -->
  <div id="nc-root"></div>
  
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
</body>
</html>