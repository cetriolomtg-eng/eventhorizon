<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EventHorizon Admin</title>

    <!-- Favicon minimale per evitare 404 (opzionale) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3EEH%3C/text%3E%3C/svg%3E">

    <!-- Bridge PRECOCE per non perdere i messaggi OAuth -->
    <script>
      (function () {
        window.__oauthQueue = [];

        function isAuthMsg(s) {
          return typeof s === "string" && (
            s.startsWith("authorization:github:success:") ||
            s.startsWith("authorization:github:error:")
          );
        }

        function enqueue(msg) {
          try { window.__oauthQueue.push(String(msg)); } catch(_) {}
        }

        // 1) ricevi da popup
        window.addEventListener("message", function (e) {
          if (!e || typeof e.data !== "string") return;
          if (!isAuthMsg(e.data)) return;
          enqueue(e.data);
        }, false);

        // 2) leggi fallback via hash/query
        (function takeFromUrl() {
          var raw = location.hash ? decodeURIComponent(location.hash.slice(1)) : "";
          if (!raw && location.search) {
            var q = new URLSearchParams(location.search);
            raw = q.get("authorization") || "";
          }
          if (isAuthMsg(raw)) enqueue(raw);
        })();

        // 3) ripubblica localmente (origin corretto) con qualche retry per coprire race
        var tries = 0, maxTries = 20;
        var iv = setInterval(function () {
          if (window.__oauthQueue && window.__oauthQueue.length) {
            var copy = window.__oauthQueue.slice();
            window.__oauthQueue.length = 0;
            copy.forEach(function (m) {
              window.postMessage(m, window.location.origin);
            });
          }
          tries++;
          if (tries >= maxTries) clearInterval(iv);
        }, 150);

        // pulizia hash dopo che Decap ha avuto tempo di leggerlo
        setTimeout(function () {
          var raw = location.hash ? decodeURIComponent(location.hash.slice(1)) : "";
          if (raw && isAuthMsg(raw)) {
            history.replaceState(null, "", location.pathname);
          }
        }, 2000);
      })();
    </script>

    <!-- Carica Decap una SOLA volta; niente CMS.init() -->
    <script src="https://unpkg.com/decap-cms@^3.8.3/dist/decap-cms.js" defer></script>

    <!-- (Opzionale) debug sintetico -->
    <script defer>
      window.addEventListener("message", function (e) {
        var d = e && e.data;
        if (typeof d === "string" && d.startsWith("authorization:github:")) {
          // console.log("[admin-bridge] msg:", d.slice(0, 80) + "â€¦");
        }
      });
    </script>
  </head>
  <body>
    <noscript>Abilita JavaScript per usare l'area amministrativa.</noscript>
  </body>
</html>

