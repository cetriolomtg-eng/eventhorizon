{{/* ===========================
   META HEAD (GitHub Pages safe)
   - Manifest & icons via relURL
   - CSS bundle via Pipes (no SRI) + fallback static
   =========================== */}}

{{/* Canonical (consente override via .Params.canonical) */}}
{{- $canonical := .Permalink -}}
{{- with .Params.canonical -}}
  {{- $canonical = . | safeURL -}}
{{- end -}}

{{/* Open Graph fallback (site params piatti o annidati) */}}
{{- $siteOG := .Site.Params.og -}}
{{- $siteOgTitle   := cond (and $siteOG (isset $siteOG "title"))        $siteOG.title       "" -}}
{{- $siteOgDesc    := cond (and $siteOG (isset $siteOG "description"))  $siteOG.description "" -}}
{{- $siteOgImage   := cond (and $siteOG (isset $siteOG "image"))        $siteOG.image       "" -}}
{{- $siteOgLocale  := cond (and $siteOG (isset $siteOG "locale"))       $siteOG.locale      "" -}}

{{- $ogTitle  := or .Params.ogTitle  .Site.Params.ogTitle  $siteOgTitle  .Site.Title -}}
{{- $ogDesc   := or .Params.ogDesc   .Site.Params.ogDesc   $siteOgDesc   "" -}}
{{- $ogImage  := or .Params.ogImage  .Site.Params.ogImage  $siteOgImage  "" -}}
{{- $ogLocale := or .Params.ogLocale .Site.Params.ogLocale $siteOgLocale "it_IT" -}}

{{- $ogImageAbs := cond (hasPrefix (lower $ogImage) "http") $ogImage ($ogImage | absURL) -}}

<!-- Base meta -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
{{- if $ogDesc }}<meta name="description" content="{{ $ogDesc }}">{{ end }}

<!-- Canonical -->
<link rel="canonical" href="{{ $canonical }}">

<!-- Manifest (no path assoluto) -->
<link rel="manifest" href="{{ "site.webmanifest" | relURL }}">

<!-- Theme color -->
<meta name="theme-color" content="{{ or .Site.Params.themeColor "#0E0F1A" }}">

<!-- Favicons (metti i file in static/assets/favicon/...) -->
<link rel="icon" href="{{ "assets/favicon/favicon.ico" | relURL }}" sizes="any">
<link rel="icon" href="{{ "assets/favicon/favicon.svg" | relURL }}" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="16x16" href="{{ "assets/favicon/favicon-16.png" | relURL }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ "assets/favicon/favicon-32.png" | relURL }}">
<link rel="icon" type="image/png" sizes="48x48" href="{{ "assets/favicon/favicon-48.png" | relURL }}">
<link rel="icon" type="image/png" sizes="96x96" href="{{ "assets/favicon/favicon-96.png" | relURL }}">
<link rel="apple-touch-icon" href="{{ "assets/favicon/apple-touch-icon.png" | relURL }}" sizes="180x180">
<link rel="icon" type="image/png" sizes="192x192" href="{{ "assets/favicon/favicon-192.png" | relURL }}">
<link rel="icon" type="image/png" sizes="512x512" href="{{ "assets/favicon/favicon-512.png" | relURL }}">
<link rel="icon" type="image/png" sizes="512x512" href="{{ "assets/favicon/favicon-512-maskable.png" | relURL }}" purpose="any maskable">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="{{ $ogTitle }}">
{{- if $ogDesc }}<meta property="og:description" content="{{ $ogDesc }}">{{ end -}}
<meta property="og:url" content="{{ $canonical }}">
{{- if $ogImageAbs }}<meta property="og:image" content="{{ $ogImageAbs }}">{{ end -}}
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:locale" content="{{ $ogLocale }}">
<meta property="og:site_name" content="{{ or .Site.Params.siteName .Site.Title }}">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ $ogTitle }}">
{{- if $ogDesc }}<meta name="twitter:description" content="{{ $ogDesc }}">{{ end -}}
{{- if $ogImageAbs }}<meta name="twitter:image" content="{{ $ogImageAbs }}">{{ end -}}

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;500;600;700;900&family=Lexend+Giga:wght@800&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap">

<!-- Preload hero (se relativo â†’ relURL) -->
{{ with .Site.Params.preloadHero }}
<link rel="preload" as="image" href="{{ cond (hasPrefix (lower .) "http") . (. | relURL) }}">
{{ end }}

{{/* ===========================
   CSS bundle (no SRI) con fallback static
   - Cerca i sorgenti in /assets/...
   - Se non li trova, include i CSS da /static/...
   =========================== */}}
{{- $cssPaths := slice
    "style/base/_style.css"
    "style/layout/_subhero.css"
    "style/components/_cards.css"
    "style/components/_portal.css"
    "style/components/_links.css"
    "style/components/_contacts.css"
-}}

{{- $parts := slice -}}
{{- range $cssPaths -}}
  {{- with resources.Get . -}}
    {{/* Abilita {{ ... }} dentro i CSS se servono path |relURL */}}
    {{- $tmpl := . | resources.ExecuteAsTemplate . $ -}}
    {{- $parts = $parts | append $tmpl -}}
  {{- end -}}
{{- end -}}

{{- if gt (len $parts) 0 -}}
  {{- $bundle := ($parts | resources.Concat "style/bundle.css") | resources.Minify | resources.Fingerprint -}}
  <link rel="stylesheet" href="{{ $bundle.RelPermalink }}">
{{- else -}}
  {{/* Fallback: file presenti in /static/... */}}
  <link rel="stylesheet" href="{{ "style/base/_style.css" | relURL }}">
  <link rel="stylesheet" href="{{ "style/layout/_subhero.css" | relURL }}">
  <link rel="stylesheet" href="{{ "style/components/_cards.css" | relURL }}">
  <link rel="stylesheet" href="{{ "style/components/_portal.css" | relURL }}">
  <link rel="stylesheet" href="{{ "style/components/_links.css" | relURL }}">
  <link rel="stylesheet" href="{{ "style/components/_contacts.css" | relURL }}">
{{- end -}}
