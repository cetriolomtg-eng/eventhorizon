{{/* ===========================
   SCRIPTS
   - JS bundle con SRI (se assets/ presenti) + fallback static
   - archive.js caricato solo su pagine archivio
   =========================== */}}

{{- $jsPaths := slice
    "scripts/script.js"
    "scripts/subhero.js"
    "scripts/links.js"
-}}

{{- $.Scratch.Set "jsParts" (slice) -}}
{{- range $p := $jsPaths -}}
  {{- with resources.Get $p -}}
    {{- $.Scratch.Add "jsParts" (slice .) -}}
  {{- else -}}
    {{- warnf "scripts.html: risorsa JS non trovata in assets/: %s" $p -}}
  {{- end -}}
{{- end -}}
{{- $parts := $.Scratch.Get "jsParts" -}}

{{- if gt (len $parts) 0 -}}
  {{- $bundle := ($parts | resources.Concat "script/bundle.js") | resources.Minify | resources.Fingerprint -}}
  <script defer src="{{ $bundle.RelPermalink }}" integrity="{{ $bundle.Data.Integrity }}" crossorigin="anonymous"></script>
{{- else -}}
  {{- if (fileExists "static/script/bundle.min.js") -}}
    <script defer src="{{ "script/bundle.min.js" | relURL }}"></script>
  {{- else if (fileExists "static/script/bundle.js") -}}
    <script defer src="{{ "script/bundle.js" | relURL }}"></script>
  {{- else -}}
    {{- range (slice
        "script/script.js"
        "script/subhero.js"
        "script/links.js") -}}
      {{- if (fileExists (printf "static/%s" .)) -}}
        <script defer src="{{ . | relURL }}"></script>
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

<!-- >>> START: archive.js solo su /archive/ -->
{{ if or (eq .Section "archive") (eq .Type "archive") (eq .Type "archivio") }}
  <script>
    window.__ARCHIVE_ENDPOINT__ = "{{ "/archive/list.json" | relURL }}";
  </script>

  {{- with resources.Get "scripts/archive.js" -}}
    {{- $archive := ( . | resources.Minify | resources.Fingerprint ) -}}
    <script defer src="{{ $archive.RelPermalink }}" integrity="{{ $archive.Data.Integrity }}" crossorigin="anonymous"></script>
  {{- else -}}
    {{- if (fileExists "static/script/archive.min.js") -}}
      <script defer src="{{ "script/archive.min.js" | relURL }}"></script>
    {{- else if (fileExists "static/script/archive.js") -}}
      <script defer src="{{ "script/archive.js" | relURL }}"></script>
    {{- else if (fileExists "static/scripts/archive.js") -}}
      <script defer src="{{ "scripts/archive.js" | relURL }}"></script>
    {{- else if (fileExists "static/js/archive.js") -}}
      <script defer src="{{ "js/archive.js" | relURL }}"></script>
    {{- else -}}
      {{- warnf "scripts.html: nessun archive.js trovato (assets/ o static/)" -}}
    {{- end -}}
  {{- end -}}
{{ end }}
<!-- <<< END -->
