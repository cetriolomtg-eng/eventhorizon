{{/* layouts/partials/scripts.html
     Bundle JS via Hugo Pipes (robusto ai file mancanti)
     Ordine preservato: script.js → subhero.js → links.js → archive.js
     Sorgenti attesi in: /assets/scripts/
*/}}

{{- $jsPaths := slice
    "scripts/script.js"
    "scripts/subhero.js"
    "scripts/links.js"
    "scripts/archive.js"
-}}

{{- /* Costruzione lista parts con Scratch per evitare problemi di scope */ -}}
{{- $.Scratch.Set "jsParts" (slice) -}}
{{- range $p := $jsPaths -}}
  {{- with resources.Get $p -}}
    {{- $.Scratch.Add "jsParts" (slice .) -}}
  {{- else -}}
    {{- /* File mancante: non interrompere la build */ -}}
    {{- warnf "scripts.html: risorsa JS non trovata: %s" $p -}}
  {{- end -}}
{{- end -}}
{{- $parts := $.Scratch.Get "jsParts" -}}

{{- if gt (len $parts) 0 -}}
  {{- $bundle := ($parts | resources.Concat "script/bundle.js") | resources.Minify | resources.Fingerprint -}}
  <script defer src="{{ $bundle.RelPermalink }}" integrity="{{ $bundle.Data.Integrity }}" crossorigin="anonymous"></script>
{{- else -}}
  {{- /* Nessun JS disponibile: niente output */ -}}
{{- end -}}
<!-- >>> START: load archive.js solo su /archive/ -->
{{ if eq .Section "archive" }}
  <script>
    (function () {
      var base = document.documentElement.getAttribute('data-base-url') || '';
      if (!base) {
        base = window.location.origin;
      }
      var normalized = base.replace(/\/$/, '');
      window.__ARCHIVE_ENDPOINT__ = normalized + '/archive/list.json';
    })();
  </script>
  <script>
    // Normalize placeholder text on archive search (fix legacy artifacts)
    window.addEventListener('DOMContentLoaded', function () {
      var form = document.getElementById('archive-search-form');
      if (!form) return;
      var q = form.querySelector('#q');
      if (!q) return;
      var mqPhone = window.matchMedia ? window.matchMedia('(max-width: 768px)') : { matches: false };
      var setPH = function () {
        q.placeholder = mqPhone.matches ? 'Cerca' : 'Cerca per titolo, descrizione, tag';
      };
      setPH();
      if (mqPhone.addEventListener) mqPhone.addEventListener('change', setPH);
      else if (mqPhone.addListener) mqPhone.addListener(setPH);
    });
  </script>
{{ end }}
<!-- <<< END: load archive.js solo su /archive/ -->



<!-- OAuth token catcher: se il provider reindirizza fuori da /admin -->
<script>
  (function () {
    try {
      var path = window.location.pathname || '';
      if (/^\/admin\/?/.test(path)) return; // solo fuori da /admin

      var h = window.location.hash || '';
      var q = window.location.search || '';
      var forwardHash = null;

      // 1) Legacy Decap/Netlify formato nel hash
      if (h && h !== '#') {
        var hh = h.charAt(0) === '#' ? h : '#' + h;
        if (hh.indexOf('#authorization:github:success:') === 0 || /[#&](access_token|token)=/.test(hh)) {
          forwardHash = hh;
        }
      }

      // 2) Token in query string (es. ?access_token=...)
      if (!forwardHash && q && q.length > 1) {
        var qs = q.charAt(0) === '?' ? q.slice(1) : q;
        try {
          var params = new URLSearchParams(qs);
          if (params.get('access_token') || params.get('token')) {
            forwardHash = '#' + qs;
          }
        } catch (_) {}
      }

      if (forwardHash) {
        var target = '/admin/' + (forwardHash.charAt(0) === '#' ? forwardHash.slice(1) : forwardHash);
        // Usa replace per non lasciare la pagina precedente nella history
        window.location.replace('/admin/' + forwardHash.replace(/^#/, ''));
      }
    } catch (_) {}
  })();
  </script>
