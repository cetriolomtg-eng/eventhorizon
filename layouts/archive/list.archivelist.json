{{- $list := slice -}}
{{- $seen := newScratch -}}
{{- with .Site.Data.archive.items -}}
  {{- range $k, $it := . -}}
    {{- if not $it.draft -}}
      {{- $key := or $it.id (or $it.slug $k) -}}
      {{- if not ($seen.Get $key) -}}
      {{- $links := slice -}}
      {{- with $it.links -}}
        {{- $t := printf "%T" . -}}
        {{- if hasPrefix $t "[]" -}}
          {{- $links = sort . "sort_order" "asc" -}}
        {{- else if hasPrefix $t "map[" -}}
          {{- $links = slice . -}}
        {{- end -}}
      {{- end -}}
      {{- $tags := slice -}}
      {{- with $it.tags -}}
        {{- $tt := printf "%T" . -}}
        {{- if hasPrefix $tt "[]" -}}
          {{- $tags = . -}}
        {{- else -}}
          {{- $tags = slice . -}}
        {{- end -}}
      {{- end -}}
      {{- $list = $list | append (dict
        "id"        $key
        "slug"      $it.slug
        "kind"      $it.kind
        "date"      $it.date
        "title"     $it.title
        "overline"  $it.overline
        "desc"      $it.desc
        "thumb"     $it.thumb
        "tags"      $tags
        "links"     $links
      ) -}}
      {{- $seen.Set $key true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $sorted := sort $list "date" "desc" -}}
{{- $sorted | jsonify -}}
