{{ define "main" }}
<!-- build-id: list-no-first-v2 -->
<section class="archive" aria-labelledby="archive-title">
  <!-- Mini hero -->
  <header class="mini-hero">
    <h1 id="archive-title" class="page-title">{{ .Title }}</h1>
    {{ with .Params.description }}
      <p class="page-desc">{{ . }}</p>
    {{ end }}
  </header>

  <!-- Controlli / Ricerca -->
  <section class="archive-controls" aria-label="Filtri e ricerca">
    <details class="archive-search">
      <summary class="archive-search__filter-toggle" role="button" aria-label="Mostra o nascondi i filtri">
        Filtri
      </summary>

      <form class="archive-search__form" role="search" novalidate autocomplete="off">
        <div class="field">
          <label for="q">Cerca</label>
          <input type="search" name="q" id="q" placeholder="Cerca per titolo, descrizione o tag">
        </div>

        <div class="field">
          <label for="kind">Tipo</label>
          <select name="kind" id="kind">
            <option value="">Tutti</option>
            <option value="video">Video</option>
            <option value="content">Contenuti</option>
            <option value="portal">Portali</option>
          </select>
        </div>

        <div class="actions">
          <button type="reset" class="archive-search__reset">Reset</button>
        </div>
      </form>
    </details>
  </section>

  <!-- Risultati -->
  <section class="archive-results" aria-live="polite">
    <ul class="archive-list" id="archive-list">
      {{/* Raccogli dagli YAML, escludi draft, ordina per data desc */}}
      {{ $items := slice }}
      {{ range $k, $it := .Site.Data.archive.items }}
        {{ if not $it.draft }}
          {{ $items = $items | append $it }}
        {{ end }}
      {{ end }}
      {{ $items = sort $items "date" "desc" }}

      {{ range $i, $it := $items }}
        {{/* >>> START: prep variabili sicure (no | first) */}}
        {{ $tagsStr := "" }}
        {{ with $it.tags }}
          {{ $tagsStr = delimit . "," }}
        {{ end }}

        {{ $links := slice }}
        {{ with $it.links }}
          {{ $links = sort . "sort_order" "asc" }}
        {{ end }}

        {{ $primaries := where $links "primary" true }}
        {{ $hasPrimary := gt (len $primaries) 0 }}
        {{ $thumb := or $it.thumb "/img/placeholders/fblthp_placeholder.webp" }}
        {{/* <<< END: prep variabili sicure */}}

        <li class="item is-{{ $it.kind }}"
            data-id="{{ $it.id }}"
            data-kind="{{ $it.kind }}"
            data-title="{{ $it.title }}"
            data-overline="{{ $it.overline }}"
            data-desc="{{ $it.desc }}"
            data-tags="{{ $tagsStr }}">
          <div class="item-thumb">
            {{ if $hasPrimary }}
              {{ $p := index $primaries 0 }}
              <a href="{{ $p.href }}" class="thumb-link" aria-label="Apri: {{ $it.title }}">
                <img src="{{ $thumb }}" alt="" loading="lazy" decoding="async" />
              </a>
            {{ else }}
              <div class="thumb">
                <img src="{{ $thumb }}" alt="" loading="lazy" decoding="async" />
              </div>
            {{ end }}
          </div>

          <div class="item-content">
            {{ with $it.overline }}<div class="item-overline">{{ . }}</div>{{ end }}
            <h3 class="item-title">{{ $it.title }}</h3>
            {{ with $it.desc }}<p class="item-desc">{{ . }}</p>{{ end }}

            <div class="item-actions">
              <div class="item-pills">
                {{ range $l := $links }}
                  {{ if not $l.primary }}
                    <a href="{{ $l.href }}" class="btn {{ $l.btn_class }}">{{ $l.label }}</a>
                  {{ end }}
                {{ end }}
              </div>

              <!-- Chevron/button per aprire il bottom-sheet; testo vuoto (icona via CSS), con ARIA -->
              <button type="button"
                      class="item-actions-summary"
                      aria-label="Dettagli e link"
                      data-item-id="{{ $it.id }}"></button>
            </div>
          </div>
        </li>
      {{ end }}
    </ul>

    <div class="archive-empty" id="archive-empty" hidden>Nessun elemento trovato.</div>
  </section>

  <!-- Bottom sheet (overlay dettagli) -->
  <div class="archive-sheet-backdrop" hidden></div>
  <aside class="archive-sheet" role="dialog" aria-modal="true" aria-hidden="true">
    <button type="button" class="archive-sheet__close" aria-label="Chiudi">Ã—</button>
    <div class="item-details"><!-- popolato da JS --></div>
  </aside>

  <!-- Contenuto opzionale dalla pagina -->
  {{ with .Content }}
    <div class="page-content">
      {{ . }}
    </div>
  {{ end }}
</section>
{{ end }}
